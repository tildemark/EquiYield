(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[983],{220:(e,a,s)=>{"use strict";function t(){{let e=window.location.hostname;return"http://".concat(e,":4000")}}s.d(a,{h:()=>t})},1101:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>c});var t=s(4568),r=s(7620),l=s(7541),n=s(9664),d=s.n(n),i=s(220);function o(){let e=localStorage.getItem("eq_admin_token");return e?{Authorization:"Bearer ".concat(e)}:{}}function c(){let[e,a]=(0,r.useState)(!1),[s,n]=(0,r.useState)(null),c=(0,l.useRouter)(),[m,x]=(0,r.useState)([]),[u,h]=(0,r.useState)(!1),[b,p]=(0,r.useState)(""),[g,y]=(0,r.useState)(""),[j,f]=(0,r.useState)("MEMBER"),[N,v]=(0,r.useState)(""),[w,E]=(0,r.useState)(""),[M,S]=(0,r.useState)(""),[k,C]=(0,r.useState)(""),[R,I]=(0,r.useState)(""),[P,F]=(0,r.useState)(""),[B,L]=(0,r.useState)([]),[_,T]=(0,r.useState)(""),[A,O]=(0,r.useState)(0),[q,D]=(0,r.useState)(0),[z,H]=(0,r.useState)(0),[J,U]=(0,r.useState)(0),[G,K]=(0,r.useState)(0),[Q,V]=(0,r.useState)(0),[W,X]=(0,r.useState)(0);(0,r.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("edit");e&&(a(!0),n(parseInt(e)));let s=async()=>{try{let e=(0,i.h)(),a=await fetch("".concat(e,"/api/admin/funds-available"),{headers:o(),cache:"no-store"});if(a.ok){let e=await a.json();O(e.availableForLoans),D(e.totalCollections),H(e.totalLoanAmount)}}catch(e){console.error("Failed to fetch available funds:",e)}};(async()=>{try{let e=(0,i.h)(),a=await fetch("".concat(e,"/api/admin/users?pageSize=1000"),{headers:o(),cache:"no-store"});if(a.ok){let e=await a.json(),s=Array.isArray(e)?e:e.data;x(s)}}catch(e){console.error("Failed to fetch members:",e)}})(),s(),e&&(async()=>{try{let a=(0,i.h)(),s=await fetch("".concat(a,"/api/admin/loans/").concat(e,"/details"),{headers:o(),cache:"no-store"});if(!s.ok)throw Error("Failed to fetch loan");let t=await s.json();f(t.borrowerType),t.user&&v(t.user.id.toString()),E(t.borrowerName),S(t.borrowerEmail),C(t.borrowerPhone),I(t.principal.toString()),F(t.termMonths.toString()),L(t.coMakers.map(e=>e.user.id.toString()))}catch(e){p("Failed to load loan details: "+e.message)}})()},[]),(0,r.useEffect)(()=>{let e="MEMBER"===j?.05:.1;U(e);let a=parseInt(R)||0,s=parseInt(P)||0,t=Math.round(a*e*s);K(t);let r=a+t;V(r),X(s>0?Math.round(r/s):0)},[j,R,P]),(0,r.useEffect)(()=>{if("MEMBER"===j&&N){let e=m.find(e=>e.id===parseInt(N));e&&(E(e.full_name),S(e.email),C(e.phone_number))}},[N,j,m]);let Y=async a=>{a.preventDefault(),p(""),y(""),h(!0);try{if(!w||!M||!k||!R||!P)throw Error("Please fill in all required fields");if("MEMBER"===j&&!N)throw Error("Please select a member");let a={borrowerType:j,userId:"MEMBER"===j?parseInt(N):void 0,borrowerName:w,borrowerEmail:M,borrowerPhone:k,principal:parseInt(R),termMonths:parseInt(P),coMakers:B.map(e=>parseInt(e))},t=(0,i.h)(),r=e?"".concat(t,"/api/admin/loans/").concat(s):"".concat(t,"/api/admin/loans"),l=await fetch(r,{method:e?"PUT":"POST",headers:{"Content-Type":"application/json",...o()},body:JSON.stringify(a)});if(!l.ok){let a=await l.json(),s="string"==typeof a.error?a.error:JSON.stringify(a.error);throw Error(s||(e?"Failed to update loan":"Failed to create loan"))}y(e?"Loan updated successfully!":"Loan created successfully!"),setTimeout(()=>{c.push("/admin/loans")},1500)}catch(e){p(e.message)}finally{h(!1)}},Z=e=>new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:0}).format(e),$=m.filter(e=>!B.includes(e.id.toString())),ee=m.find(e=>e.id===parseInt(N));return(0,t.jsxs)("div",{className:"p-6",children:[(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)(d(),{href:"/admin/loans",className:"text-blue-600 hover:underline",children:"← Back to Loans"}),(0,t.jsx)("h1",{className:"mt-2 text-3xl font-bold text-gray-900",children:e?"Edit Loan":"Create Loan"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-3",children:[(0,t.jsx)("div",{className:"lg:col-span-2",children:(0,t.jsxs)("form",{onSubmit:Y,className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[b&&(0,t.jsx)("div",{className:"mb-4 rounded-lg border border-red-200 bg-red-50 p-4 text-red-700",children:b}),g&&(0,t.jsx)("div",{className:"mb-4 rounded-lg border border-green-200 bg-green-50 p-4 text-green-700",children:g}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Borrower Type"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{className:"flex items-center",children:[(0,t.jsx)("input",{type:"radio",value:"MEMBER",checked:"MEMBER"===j,onChange:e=>{f(e.target.value),v(""),E(""),S(""),C("")},className:"mr-2"}),(0,t.jsx)("span",{className:"text-gray-700",children:"Member (5% per month)"})]}),(0,t.jsxs)("label",{className:"flex items-center",children:[(0,t.jsx)("input",{type:"radio",value:"NON_MEMBER",checked:"NON_MEMBER"===j,onChange:e=>{f(e.target.value),v(""),E(""),S(""),C("")},className:"mr-2"}),(0,t.jsx)("span",{className:"text-gray-700",children:"Non-member (10% per month)"})]})]})]}),"MEMBER"===j&&(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("label",{htmlFor:"member",className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Member *"}),(0,t.jsxs)("select",{id:"member",value:N,onChange:e=>v(e.target.value),className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900",children:[(0,t.jsx)("option",{value:"",children:"-- Choose a member --"}),m.map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.full_name," (",e.email,")"]},e.id))]})]}),(0,t.jsxs)("div",{className:"mb-6 rounded-lg bg-gray-50 p-4",children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900 mb-4",children:"Borrower Information"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Name *"}),(0,t.jsx)("input",{id:"name",type:"text",value:w,onChange:e=>E(e.target.value),disabled:"MEMBER"===j&&void 0!==ee,className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900 disabled:bg-gray-100",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email *"}),(0,t.jsx)("input",{id:"email",type:"email",value:M,onChange:e=>S(e.target.value),disabled:"MEMBER"===j&&void 0!==ee,className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900 disabled:bg-gray-100",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone *"}),(0,t.jsx)("input",{id:"phone",type:"tel",value:k,onChange:e=>C(e.target.value),disabled:"MEMBER"===j&&void 0!==ee,className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900 disabled:bg-gray-100",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"principal",className:"block text-sm font-medium text-gray-700 mb-1",children:"Principal Amount (₱) *"}),(0,t.jsx)("input",{id:"principal",type:"number",value:R,onChange:e=>I(e.target.value),className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"termMonths",className:"block text-sm font-medium text-gray-700 mb-1",children:"Loan Term (months) *"}),(0,t.jsx)("input",{id:"termMonths",type:"number",min:"1",max:"60",value:P,onChange:e=>F(e.target.value),className:"w-full rounded border border-gray-300 px-3 py-2 text-gray-900",placeholder:"e.g., 6, 12, 24",required:!0}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Loan repayment period in months"})]})]})]}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900 mb-4",children:"Co-makers"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("select",{value:_,onChange:e=>T(e.target.value),className:"flex-1 rounded border border-gray-300 px-3 py-2 text-gray-900",children:[(0,t.jsx)("option",{value:"",children:"-- Select co-maker --"}),$.map(e=>(0,t.jsx)("option",{value:e.id,children:e.full_name},e.id))]}),(0,t.jsx)("button",{type:"button",onClick:()=>{_&&!B.includes(_)&&(L([...B,_]),T(""))},disabled:!_,className:"rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Add"})]}),B.length>0&&(0,t.jsx)("div",{className:"space-y-2",children:B.map(e=>{let a=m.find(a=>a.id===parseInt(e));return a?(0,t.jsxs)("div",{className:"flex items-center justify-between rounded border border-gray-200 bg-gray-50 p-2 px-3",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:a.full_name}),(0,t.jsx)("button",{type:"button",onClick:()=>{L(B.filter(a=>a!==e))},className:"text-red-600 hover:text-red-800 text-sm",children:"Remove"})]},e):null})})]})]}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{type:"submit",disabled:u,className:"flex-1 rounded bg-green-600 px-4 py-2 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:u?"Creating...":"Create Loan"}),(0,t.jsx)(d(),{href:"/admin/loans",className:"rounded border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50 font-medium",children:"Cancel"})]})]})}),R&&P&&(0,t.jsx)("div",{className:"lg:col-span-1",children:(0,t.jsxs)("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm sticky top-6 space-y-4",children:[(0,t.jsxs)("div",{className:"border-b border-gray-200 pb-4",children:[(0,t.jsx)("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3",children:"Available Funds for Loan"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Total Collections:"}),(0,t.jsx)("span",{className:"font-medium text-gray-900",children:Z(q)})]}),(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Outstanding Loans:"}),(0,t.jsxs)("span",{className:"font-medium text-red-600",children:["−",Z(z)]})]}),(0,t.jsxs)("div",{className:"flex justify-between text-sm bg-blue-50 p-2 rounded font-semibold",children:[(0,t.jsx)("span",{className:"text-blue-900",children:"Can Release:"}),(0,t.jsx)("span",{className:"text-blue-700",children:Z(A)})]}),parseInt(R)>A&&(0,t.jsxs)("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded",children:["⚠️ Loan amount exceeds available funds by ",Z(parseInt(R)-A)]})]})]}),(0,t.jsx)("h3",{className:"font-semibold text-gray-900 mb-2",children:"Loan Summary"}),(0,t.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Loan Type:"}),(0,t.jsx)("span",{className:"font-medium text-gray-900",children:"MEMBER"===j?"Member (5%/mo)":"Non-member (10%/mo)"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Principal:"}),(0,t.jsx)("span",{className:"font-medium text-gray-900",children:Z(parseInt(R)||0)})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Term:"}),(0,t.jsxs)("span",{className:"font-medium text-gray-900",children:[P," months"]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Interest Rate:"}),(0,t.jsxs)("span",{className:"font-medium text-gray-900",children:[(100*J).toFixed(0),"% per month"]})]}),(0,t.jsxs)("div",{className:"border-t border-gray-200 pt-3 mt-3",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsxs)("span",{className:"text-gray-600",children:["Total Interest (",(100*J).toFixed(0),"% \xd7 ",P,"mo):"]}),(0,t.jsx)("span",{className:"font-semibold text-gray-900",children:Z(G)})]}),(0,t.jsxs)("div",{className:"flex justify-between mt-3 bg-blue-50 p-3 rounded",children:[(0,t.jsx)("span",{className:"text-gray-700 font-medium",children:"Total Amount Due:"}),(0,t.jsx)("span",{className:"font-bold text-blue-700",children:Z(Q)})]}),(0,t.jsxs)("div",{className:"flex justify-between mt-3 bg-green-50 p-3 rounded text-base",children:[(0,t.jsx)("span",{className:"text-gray-700 font-semibold",children:"Monthly Payment:"}),(0,t.jsx)("span",{className:"font-bold text-green-700",children:Z(W)})]})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-600 bg-gray-50 p-2 rounded mt-3 space-y-1",children:[(0,t.jsx)("div",{children:(0,t.jsx)("strong",{children:"Formula:"})}),(0,t.jsxs)("div",{children:["Interest = ₱",parseInt(R)||0," \xd7 ",(100*J).toFixed(0),"% \xd7 ",P," = ₱",G]}),(0,t.jsxs)("div",{children:["Payment = ₱",Q," \xf7 ",P," = ₱",W,"/month"]})]})]})]})})]})]})}},6354:(e,a,s)=>{Promise.resolve().then(s.bind(s,1101))},7541:(e,a,s)=>{"use strict";var t=s(3041);s.o(t,"useParams")&&s.d(a,{useParams:function(){return t.useParams}}),s.o(t,"usePathname")&&s.d(a,{usePathname:function(){return t.usePathname}}),s.o(t,"useRouter")&&s.d(a,{useRouter:function(){return t.useRouter}})}},e=>{e.O(0,[664,587,18,358],()=>e(e.s=6354)),_N_E=e.O()}]);