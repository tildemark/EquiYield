(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[490],{220:(e,t,a)=>{"use strict";function s(){{let e=window.location.hostname;return"http://".concat(e,":4000")}}a.d(t,{h:()=>s})},2948:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var s=a(4568),r=a(7620),l=a(9664),d=a.n(l),n=a(220);function i(){let e=localStorage.getItem("eq_admin_token");return e?{Authorization:"Bearer ".concat(e)}:{}}function c(){let[e,t]=(0,r.useState)([]),[a,l]=(0,r.useState)(1),[c,o]=(0,r.useState)(20),[x,m]=(0,r.useState)(0),[h,g]=(0,r.useState)(0),[y,b]=(0,r.useState)(!0),[p,u]=(0,r.useState)(""),[N,j]=(0,r.useState)(""),[f,v]=(0,r.useState)(""),[w,D]=(0,r.useState)(null),[S,P]=(0,r.useState)(!1),[A,k]=(0,r.useState)(!1),[C,I]=(0,r.useState)(""),[E,T]=(0,r.useState)("CASH"),[R,M]=(0,r.useState)(""),[L,_]=(0,r.useState)(new Date().toISOString().slice(0,10)),[F,H]=(0,r.useState)(!1),z=async(e,a,s)=>{try{b(!0),u("");let r=(0,n.h)(),d="".concat(r,"/api/admin/loans?page=").concat(e,"&pageSize=").concat(a);s&&(d+="&status=".concat(encodeURIComponent(s)));let c=await fetch(d,{headers:i(),cache:"no-store"});if(!c.ok)throw Error("Failed to fetch loans");let x=await c.json();t(x.data),l(x.page),o(x.pageSize),m(x.totalPages),g(x.totalItems)}catch(e){u(e.message)}finally{b(!1)}},G=async e=>{try{k(!0);let t=(0,n.h)(),a=await fetch("".concat(t,"/api/admin/loans/").concat(e,"/details"),{headers:i(),cache:"no-store"});if(!a.ok)throw Error("Failed to fetch loan details");let s=await a.json();D(s),I("")}catch(e){console.error(e),alert("Failed to load loan details")}finally{k(!1)}},O=async e=>{P(!0),await G(e.id)},B=()=>{P(!1),D(null),I("")},q=(0,r.useMemo)(()=>{if(!w)return[];let e=[...w.payments||[]].map(e=>({...e,remaining:e.amount,payDate:e.date_paid||e.createdAt})).sort((e,t)=>new Date(e.payDate).getTime()-new Date(t.payDate).getTime());return w.amortization.map(t=>{let a=0,s=null;for(let r of e){if(a>=t.amount)break;if(r.remaining<=0)continue;let e=Math.min(r.remaining,t.amount-a);e>0&&(r.remaining-=e,a+=e,s=r.payDate)}let r=a>=t.amount?"PAID":a>0?"PARTIAL":"UNPAID";return{...t,paidAmount:a,status:r,paymentDate:s}})},[w]),U=async()=>{if(!w||!C)return;let e=Number(C);if(isNaN(e)||e<=0)return void alert("Please enter a valid amount");try{H(!0);let t=(0,n.h)(),s=await fetch("".concat(t,"/api/admin/loans/").concat(w.id,"/payment"),{method:"POST",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify({amount:e,payment_method:E,reference:R,date_paid:new Date(L).toISOString()})});if(!s.ok)throw Error("Failed to record payment");let r=await s.json();v(r.message),setTimeout(()=>v(""),3e3),I(""),T("CASH"),M(""),_(new Date().toISOString().slice(0,10)),await G(w.id),await z(a,c,N||void 0)}catch(e){console.error(e),alert("Failed to record payment")}finally{H(!1)}};(0,r.useEffect)(()=>{z(1,20,N||void 0)},[]);let J=e=>{j(e),z(1,20,e||void 0)},K=e=>{e>=1&&e<=x&&z(e,c,N||void 0)},Y=e=>new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:0}).format(e),Q=e=>new Date(e).toLocaleDateString("en-PH");return(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsxs)("div",{className:"mb-6 flex items-center justify-between",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Loans Management"}),(0,s.jsx)(d(),{href:"/admin/loans/create",className:"rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:"Create Loan"})]}),(0,s.jsxs)("div",{className:"mb-4 text-sm text-gray-600",children:["Note: Member-applied loans are created with status ",(0,s.jsx)("span",{className:"font-semibold",children:"PENDING"})," and require admin action. Loans created here are ",(0,s.jsx)("span",{className:"font-semibold",children:"RELEASED"})," immediately. Click on a loan row to view details and record payments."]}),(0,s.jsxs)("div",{className:"mb-6 flex items-center gap-3",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"Filter by Status:"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>J(""),className:"rounded-lg px-4 py-2 text-sm font-medium transition ".concat(""===N?"bg-blue-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"),children:"All"}),(0,s.jsx)("button",{onClick:()=>J("PENDING"),className:"rounded-lg px-4 py-2 text-sm font-medium transition ".concat("PENDING"===N?"bg-yellow-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"),children:"Pending"}),(0,s.jsx)("button",{onClick:()=>J("RELEASED"),className:"rounded-lg px-4 py-2 text-sm font-medium transition ".concat("RELEASED"===N?"bg-red-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"),children:"Released"}),(0,s.jsx)("button",{onClick:()=>J("PAID"),className:"rounded-lg px-4 py-2 text-sm font-medium transition ".concat("PAID"===N?"bg-green-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"),children:"Paid"})]})]}),f&&(0,s.jsx)("div",{className:"mb-4 rounded-lg border border-green-200 bg-green-50 p-4 text-green-700",children:f}),p&&(0,s.jsx)("div",{className:"mb-4 rounded-lg border border-red-200 bg-red-50 p-4 text-red-700",children:p}),y?(0,s.jsx)("div",{className:"text-center py-8 text-gray-600",children:"Loading..."}):0===e.length?(0,s.jsxs)("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-8 text-center text-gray-600",children:["No loans found. ",(0,s.jsx)(d(),{href:"/admin/loans/create",className:"text-blue-600 hover:underline",children:"Create the first loan"})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:(0,s.jsxs)("table",{className:"w-full",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"ID"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Borrower"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Type"}),(0,s.jsx)("th",{className:"px-6 py-3 text-right text-sm font-semibold text-gray-700",children:"Principal"}),(0,s.jsx)("th",{className:"px-6 py-3 text-right text-sm font-semibold text-gray-700",children:"Interest"}),(0,s.jsx)("th",{className:"px-6 py-3 text-right text-sm font-semibold text-gray-700",children:"Monthly Payment"}),(0,s.jsx)("th",{className:"px-6 py-3 text-center text-sm font-semibold text-gray-700",children:"Term (Months)"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Due Date"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Co-makers"})]})}),(0,s.jsx)("tbody",{children:e.map(e=>{let t=!(e.payments&&e.payments.length>0)&&"PAID"!==e.status;return(0,s.jsxs)("tr",{className:"border-b border-gray-200 hover:bg-gray-50 ".concat(t?"cursor-pointer":"cursor-default"),onClick:()=>{t?window.location.href="/admin/loans/create?edit=".concat(e.id):O(e)},title:t?"Click to edit loan":"Click to view details",children:[(0,s.jsxs)("td",{className:"px-6 py-4 text-sm text-gray-900 font-semibold",children:["#",e.id]}),(0,s.jsxs)("td",{className:"px-6 py-4 text-sm",children:[(0,s.jsx)("div",{className:"font-medium text-gray-900",children:e.borrowerName}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:e.borrowerEmail}),e.user&&(0,s.jsxs)("div",{className:"text-xs text-blue-600",children:["Member: ",e.user.full_name]})]}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm",children:(0,s.jsx)("span",{className:"inline-block px-2 py-1 rounded text-xs font-medium ".concat("MEMBER"===e.borrowerType?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"),children:e.borrowerType})}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm text-right font-medium text-gray-900",children:Y(e.principal)}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm text-right font-medium text-gray-900",children:Y(e.interest)}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm text-right font-medium text-gray-900",children:Y(e.monthlyAmortization)}),(0,s.jsx)("td",{className:"px-6 py-4 text-center text-sm font-medium text-gray-900",children:e.termMonths}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm text-gray-700",children:Q(e.dueDate)}),(0,s.jsx)("td",{className:"px-6 py-4 text-sm",children:(0,s.jsx)("span",{className:"inline-block px-2 py-1 rounded text-xs font-medium ".concat("PENDING"===e.status?"bg-yellow-100 text-yellow-800":"PAID"===e.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.status})}),(0,s.jsxs)("td",{className:"px-6 py-4 text-sm",children:[e.coMakers.length>0?(0,s.jsx)("div",{className:"space-y-1",children:e.coMakers.map(e=>(0,s.jsxs)("div",{className:"text-xs text-gray-600",children:["• ",e.user.full_name]},e.user.id))}):(0,s.jsx)("span",{className:"text-gray-400",children:"None"}),t&&(0,s.jsx)("div",{className:"mt-1",children:(0,s.jsx)("span",{className:"inline-block px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700",children:"✏️ Editable"})})]})]},e.id)})})]})}),(0,s.jsxs)("div",{className:"mt-6 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"Items per page:"}),(0,s.jsxs)("select",{value:c,onChange:e=>{var t;o(t=Number(e.target.value)),z(1,t,N||void 0)},className:"rounded border border-gray-300 px-3 py-2 text-sm",children:[(0,s.jsx)("option",{value:10,children:"10"}),(0,s.jsx)("option",{value:20,children:"20"}),(0,s.jsx)("option",{value:50,children:"50"}),(0,s.jsx)("option",{value:100,children:"100"})]}),(0,s.jsxs)("span",{className:"text-sm text-gray-600",children:["Showing ",e.length>0?(a-1)*c+1:0," to"," ",Math.min(a*c,h)," of ",h," loans"]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>K(a-1),disabled:1===a,className:"rounded border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50",children:"Previous"}),(0,s.jsxs)("span",{className:"flex items-center px-4 text-sm text-gray-700",children:["Page ",a," of ",x]}),(0,s.jsx)("button",{onClick:()=>K(a+1),disabled:a===x,className:"rounded border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50",children:"Next"})]})]})]}),S&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:(0,s.jsx)("div",{className:"card max-w-3xl w-full max-h-[90vh] overflow-y-auto",children:A?(0,s.jsx)("div",{className:"p-8 text-center text-gray-600",children:"Loading loan details..."}):w?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("h2",{className:"text-2xl font-bold text-gray-900",children:["Loan #",w.id]}),(0,s.jsx)("button",{onClick:B,className:"text-gray-400 hover:text-gray-600",children:"✕"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-6 pb-6 border-b border-gray-200",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"Name"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:w.borrowerName})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"Email"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:w.borrowerEmail})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"Phone"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:w.borrowerPhone})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"Type"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:w.borrowerType})]})]}),(0,s.jsxs)("div",{className:"mb-6 pb-6 border-b border-gray-200",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Loan Snapshot"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Principal"}),(0,s.jsx)("div",{className:"text-xl font-bold text-gray-900",children:Y(w.principal)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Interest"}),(0,s.jsx)("div",{className:"text-xl font-bold text-gray-900",children:Y(w.interest)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Total Due"}),(0,s.jsx)("div",{className:"text-xl font-bold text-gray-900",children:Y(w.totalDue)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Created"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:Q(w.createdAt)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Due Date"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:Q(w.dueDate)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Status"}),(0,s.jsx)("div",{children:(0,s.jsx)("span",{className:"inline-block px-2 py-1 rounded text-xs font-medium ".concat("PENDING"===w.status?"bg-yellow-100 text-yellow-800":"PAID"===w.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:w.status})})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Total Paid"}),(0,s.jsx)("div",{className:"text-xl font-bold text-green-600",children:Y(w.totalPaid)})]}),(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Balance"}),(0,s.jsx)("div",{className:"text-xl font-bold text-red-600",children:Y(w.balance)})]}),w.releasedAt&&(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Released"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:Q(w.releasedAt)})]}),w.settledAt&&(0,s.jsxs)("div",{className:"p-3 rounded border border-gray-200 bg-gray-50",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Settled"}),(0,s.jsx)("div",{className:"font-semibold text-gray-900",children:Q(w.settledAt)})]})]})]}),(0,s.jsxs)("div",{className:"mb-6 pb-6 border-b border-gray-200",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Payment History"}),0===w.payments.length?(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"No payments recorded yet."}):(0,s.jsx)("div",{className:"space-y-2",children:w.payments.map(e=>(0,s.jsxs)("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded",children:[(0,s.jsx)("span",{className:"text-sm text-gray-600",children:Q(e.createdAt)}),(0,s.jsx)("span",{className:"font-semibold text-gray-900",children:Y(e.amount)})]},e.id))})]}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Amortization Schedule"}),(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-100",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-2 text-left text-gray-600",children:"Month"}),(0,s.jsx)("th",{className:"px-4 py-2 text-right text-gray-600",children:"Amount Due"}),(0,s.jsx)("th",{className:"px-4 py-2 text-left text-gray-600",children:"Due Date"}),(0,s.jsx)("th",{className:"px-4 py-2 text-left text-gray-600",children:"Payment Date"}),(0,s.jsx)("th",{className:"px-4 py-2 text-left text-gray-600",children:"Status"})]})}),(0,s.jsx)("tbody",{children:q.map(e=>{let t="PAID"===e.status?"bg-green-50":"PARTIAL"===e.status?"bg-yellow-50":"";return(0,s.jsxs)("tr",{className:"border-b border-gray-100 ".concat(t),children:[(0,s.jsx)("td",{className:"px-4 py-2 text-gray-900",children:e.month}),(0,s.jsx)("td",{className:"px-4 py-2 text-right font-semibold text-gray-900",children:Y(e.amount)}),(0,s.jsx)("td",{className:"px-4 py-2 text-gray-700",children:e.dueDate}),(0,s.jsx)("td",{className:"px-4 py-2 text-gray-700",children:e.paymentDate?Q(e.paymentDate):"—"}),(0,s.jsx)("td",{className:"px-4 py-2",children:(0,s.jsx)("span",{className:"inline-block px-2 py-1 rounded text-xs font-semibold ".concat("PAID"===e.status?"bg-green-100 text-green-800":"PARTIAL"===e.status?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-700"),children:e.status})})]},e.month)})})]})})]}),"PAID"!==w.status&&(0,s.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Record Payment"}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Amount *"}),(0,s.jsx)("input",{type:"number",placeholder:"0",value:C,onChange:e=>I(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm",step:"100",min:"0"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date Paid *"}),(0,s.jsx)("input",{type:"date",value:L,onChange:e=>_(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Payment Method *"}),(0,s.jsxs)("select",{value:E,onChange:e=>T(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,s.jsx)("option",{value:"CASH",children:"Cash"}),(0,s.jsx)("option",{value:"BANK_TRANSFER",children:"Bank Transfer"}),(0,s.jsx)("option",{value:"GCASH",children:"GCash"}),(0,s.jsx)("option",{value:"INSTAPAY",children:"Instapay"})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Reference Number (optional)"}),(0,s.jsx)("input",{type:"text",placeholder:"Transaction ID, receipt number, etc.",value:R,onChange:e=>M(e.target.value),className:"w-full px-2 py-1 border border-gray-300 rounded text-sm"})]}),(0,s.jsx)("button",{onClick:U,disabled:F||!C,className:"w-full btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed",children:F?"Recording...":"Record Payment"})]})]})]}),(0,s.jsx)("div",{className:"flex gap-2",children:(0,s.jsx)("button",{onClick:B,className:"btn btn-secondary flex-1",children:"Close"})})]}):null})})]})}},3735:(e,t,a)=>{Promise.resolve().then(a.bind(a,2948))}},e=>{e.O(0,[664,587,18,358],()=>e(e.s=3735)),_N_E=e.O()}]);